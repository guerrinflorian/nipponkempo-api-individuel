name: SÃ©curitÃ© Automatique KEMPO API

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 2 * * 1" # audit automatique tous les lundis Ã  2h du matin

jobs:
  security-audit:
    name: "ğŸ”’ Audit de sÃ©curitÃ©"
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ RÃ©cupÃ©rer le code source"
        uses: actions/checkout@v3

      - name: "âš™ï¸ Configurer Node.js version 20.12.1"
        uses: actions/setup-node@v3
        with:
          node-version: "20.12.1"

      - name: "ğŸ“¦ Installer les dÃ©pendances"
        run: npm ci

      - name: "ğŸš¨ VÃ©rifier les vulnÃ©rabilitÃ©s npm"
        run: |
          echo "ğŸ” Recherche des vulnÃ©rabilitÃ©s de sÃ©curitÃ© dans les packages npm..."
          npm audit --audit-level moderate

      - name: "ğŸ”§ Afficher les corrections disponibles"
        run: |
          echo "ğŸ’¡ Liste des corrections automatiques disponibles :"
          npm audit fix --dry-run

      - name: "ğŸ“Š GÃ©nÃ©rer le rÃ©sumÃ© de sÃ©curitÃ©"
        run: |
          echo "ğŸ“‹ RÃ©sumÃ© complet de l'audit de sÃ©curitÃ© :"
          npm audit --audit-level low

  dependency-check:
    name: "ğŸ“¦ ContrÃ´le des dÃ©pendances"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: "âš™ï¸ Configurer Node.js version 20.12.1"
        uses: actions/setup-node@v3
        with:
          node-version: "20.12.1"

      - name: "ğŸ“¦ Installer les dÃ©pendances"
        run: npm ci

      - name: "ğŸ” DÃ©tecter les dÃ©pendances obsolÃ¨tes"
        run: |
          echo "ğŸ” VÃ©rification des packages avec des versions obsolÃ¨tes..."
          npm outdated || true

      - name: "ğŸ“‹ Lister toutes les dÃ©pendances installÃ©es"
        run: |
          echo "ğŸ“¦ Ã‰tat actuel de toutes les dÃ©pendances du projet :"
          npm ls --depth=0

  secrets-scan:
    name: "ğŸ”‘ DÃ©tection des secrets"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: "ğŸ” Scanner le code pour dÃ©tecter les secrets"
        run: |
          echo "ğŸ” Recherche de secrets potentiels dans le code source..."

          # chercher les clÃ©s api Ã©crites en dur dans le code
          if grep -r "api_key\|apikey\|api-key" --include="*.js" . | grep -v "process.env"; then
            echo "âš ï¸ ALERTE : ClÃ©s API trouvÃ©es en dur dans le code !"
            exit 1
          fi

          # chercher les mots de passe Ã©crits en dur
          if grep -r "password.*=" --include="*.js" . | grep -v "passwordUtils\|hashPassword\|comparePassword"; then
            echo "âš ï¸ ALERTE : Mots de passe potentiels trouvÃ©s en dur !"
            exit 1
          fi

          # chercher les secrets jwt Ã©crits en dur
          if grep -r "jwt.*secret\|secret.*jwt" --include="*.js" . | grep -v "process.env"; then
            echo "âš ï¸ ALERTE : Secrets JWT trouvÃ©s en dur dans le code !"
            exit 1
          fi

          echo "âœ… Aucun secret dÃ©tectÃ© en dur dans le code"

  env-check:
    name: "ğŸŒ ContrÃ´le des variables d'environnement"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: "ğŸ” VÃ©rifier l'utilisation correcte des variables d'environnement"
        run: |
          echo "ğŸ” ContrÃ´le de l'utilisation sÃ©curisÃ©e des variables d'environnement..."

          # vÃ©rifier que jwt_secret est bien utilisÃ© via process.env
          if ! grep -r "process.env.JWT_SECRET" --include="*.js" .; then
            echo "âš ï¸ PROBLÃˆME : JWT_SECRET n'est pas utilisÃ© via process.env"
            exit 1
          fi

          # vÃ©rifier que email_user est bien utilisÃ© via process.env
          if ! grep -r "process.env.EMAIL_USER" --include="*.js" .; then
            echo "âš ï¸ PROBLÃˆME : EMAIL_USER n'est pas utilisÃ© via process.env"
            exit 1
          fi

          echo "âœ… Toutes les variables d'environnement sont correctement utilisÃ©es"

  notify-results:
    name: "ğŸ“§ Rapport final de sÃ©curitÃ©"
    runs-on: ubuntu-latest
    needs: [security-audit, dependency-check, secrets-scan, env-check]
    if: always() # s'exÃ©cute mÃªme si d'autres jobs Ã©chouent
    steps:
      - name: "ğŸ“Š GÃ©nÃ©rer le rÃ©sumÃ© complet des vÃ©rifications"
        run: |
          echo "ğŸ“Š RAPPORT FINAL DE SÃ‰CURITÃ‰ AUTOMATIQUE"
          echo "========================================"
          echo "Projet: ${{ github.repository }}"
          echo "Commit analysÃ©: ${{ github.sha }}"
          echo "Branche: ${{ github.ref }}"
          echo "Date de l'analyse: $(date)"
          echo ""

          if [[ "${{ needs.security-audit.result }}" == "success" ]]; then
            echo "âœ… Audit de sÃ©curitÃ© npm: RÃ‰USSI"
          else
            echo "âŒ Audit de sÃ©curitÃ© npm: Ã‰CHEC"
          fi

          if [[ "${{ needs.dependency-check.result }}" == "success" ]]; then
            echo "âœ… ContrÃ´le des dÃ©pendances: RÃ‰USSI" 
          else
            echo "âŒ ContrÃ´le des dÃ©pendances: Ã‰CHEC"
          fi

          if [[ "${{ needs.secrets-scan.result }}" == "success" ]]; then
            echo "âœ… DÃ©tection des secrets: RÃ‰USSI"
          else
            echo "âŒ DÃ©tection des secrets: Ã‰CHEC - SECRETS TROUVÃ‰S !"
          fi

          if [[ "${{ needs.env-check.result }}" == "success" ]]; then
            echo "âœ… Variables d'environnement: RÃ‰USSI"
          else
            echo "âŒ Variables d'environnement: Ã‰CHEC"
          fi

          echo ""
          echo "ğŸ”— Voir les dÃ©tails complets: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
